<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FloodGuard — Community Flood Response (Pakistan)</title>

  <!-- Tailwind CDN for quick layout -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- EmailJS (optional) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    html, body, #app { height: 100%; }
    .leaflet-container { height: 420px; border-radius: 0.75rem; }
    .notification {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      max-width: 360px; padding: .75rem 1rem; border-radius: .5rem;
      box-shadow: 0 10px 20px rgba(2,6,23,0.12); color: white;
    }
    .notification.info{ background:#3b82f6 }
    .notification.success{ background:#10b981 }
    .notification.warning{ background:#f59e0b }
    .notification.error{ background:#ef4444 }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display:inline-block; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 text-gray-900">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 bg-white/90 backdrop-blur border-b z-20">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 id="title" class="text-2xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
            🌊 FloodGuard Pakistan
          </h1>
          <div id="systemStatus" class="flex items-center gap-2 text-sm text-gray-600">
            <span class="status-dot bg-green-500"></span>
            <span id="statusText">System Active</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <select id="langSelect" class="border px-2 py-1 rounded">
            <option value="en">English</option>
            <option value="ur">اردو</option>
          </select>
          <button id="saveConfig" class="px-3 py-1 rounded bg-blue-600 text-white">💾 Save</button>
          <button id="refreshWeather" class="px-3 py-1 rounded bg-gray-200">🔄 Refresh</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 w-full flex-1 space-y-6">
      <!-- CONFIG / Quick Guide -->
      <section class="grid md:grid-cols-2 gap-4">
        <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-2xl p-4 shadow">
          <h2 id="guideTitle" class="text-lg font-bold">🚀 Quick Setup</h2>
          <p id="guideText" class="text-sm opacity-90">Enter your keys and defaults. Use Live Server for best results.</p>

          <div class="mt-3 space-y-2">
            <input id="weatherApiKey" placeholder="OpenWeather API key" class="w-full rounded px-3 py-2 text-black"/>
            <div class="grid grid-cols-2 gap-2">
              <input id="emailjsPublicKey" placeholder="EmailJS Public Key" class="rounded px-3 py-2 text-black" />
              <input id="emailjsServiceId" placeholder="EmailJS Service ID" class="rounded px-3 py-2 text-black" />
            </div>
            <input id="emailjsTemplateId" placeholder="EmailJS Template ID" class="w-full rounded px-3 py-2 text-black" />
            <input id="defaultLocation" placeholder="Default Lat,Lng (e.g. 24.8607,67.0011)" class="w-full rounded px-3 py-2 text-black" />
            <select id="smsProvider" class="w-full rounded px-3 py-2 text-black">
              <option value="none">No SMS (Email Only)</option>
              <option value="webhook">Webhook</option>
              <option value="telegram">Telegram (link)</option>
            </select>
            <input id="smsConfig" placeholder="Webhook URL / Telegram chat ID" class="w-full rounded px-3 py-2 text-black" />
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4">
          <h3 id="weatherTitle" class="font-semibold">🌤️ Current Weather</h3>
          <div class="mt-2 space-y-2 text-sm">
            <div class="flex justify-between"><span id="tempLabel">Temperature:</span><span id="temp">--°C</span></div>
            <div class="flex justify-between"><span id="humLabel">Humidity:</span><span id="humidity">--%</span></div>
            <div class="flex justify-between"><span id="presLabel">Pressure:</span><span id="pressure">-- hPa</span></div>
            <div class="flex justify-between"><span id="rainLabel">Rain (1h):</span><span id="rainfall">-- mm</span></div>
            <div class="flex justify-between"><span class="text-xs text-gray-500">Updated:</span><span id="lastUpdate" class="text-xs text-gray-500">Never</span></div>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <button id="emergencyCall" class="bg-red-600 text-white py-2 rounded">📞 Call 1122</button>
            <button id="shareLocationBtn" class="bg-blue-600 text-white py-2 rounded">📍 Share Location</button>
            <button id="nearestShelterBtn" class="col-span-2 bg-green-600 text-white py-2 rounded">🧭 Nearest Shelter</button>
          </div>
        </div>
      </section>

      <!-- Map + Risk + Checklist -->
      <section class="grid lg:grid-cols-3 gap-4">
        <!-- Map -->
        <div class="lg:col-span-2 bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">🗺️ Emergency Map</h3>
            <div class="flex gap-2">
              <button id="locateMe" class="px-3 py-1 rounded border">📍 My Location</button>
              <button id="addReportBtn" class="px-3 py-1 rounded border">➕ Report</button>
            </div>
          </div>
          <div id="map" class="leaflet-container"></div>
          <div class="mt-3 flex flex-wrap gap-3 text-xs">
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded-full"></div><span>Safe Shelter</span></div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-500 rounded-full"></div><span>Danger</span></div>
            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-blue-500 rounded-full"></div><span>Reports</span></div>
          </div>
        </div>

        <!-- Risk & Checklist -->
        <div class="bg-white rounded-2xl p-4 shadow space-y-4">
          <div>
            <h4 class="font-semibold">⚠️ Flood Risk</h4>
            <div class="text-4xl font-extrabold" id="riskScore">0</div>
            <div id="riskBadge" class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 inline-block">Low Risk</div>
            <div class="text-xs text-gray-600 mt-2" id="riskDescription">Normal conditions</div>
          </div>

          <div>
            <h4 class="font-semibold">🧰 Evacuation Checklist</h4>
            <ul id="checklist" class="list-disc ml-5 text-sm mt-2 space-y-1">
              <li>CNIC / important documents in waterproof pouch</li>
              <li>Charge phone & power bank</li>
              <li>Pack water, medicines, basic food</li>
              <li>Wear strong shoes & keep warm clothes</li>
              <li>Know nearest shelter & exit route</li>
            </ul>
          </div>

          <div>
            <h4 class="font-semibold">📢 Quick Actions</h4>
            <div class="mt-2 grid gap-2">
              <button id="testEmailBtn" class="bg-blue-600 text-white py-2 rounded">📧 Test Email Alert</button>
              <button id="manualAlertBtn" class="bg-yellow-600 text-white py-2 rounded">🚨 Broadcast Alert</button>
            </div>
          </div>
        </div>
      </section>

      Report & Contacts
      <section class="grid lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl p-4 shadow">
          <h4 class="font-semibold">📸 Community Reports</h4>
          <form id="reportForm" class="mt-3 space-y-2">
            <input name="reporter" placeholder="Your name" class="w-full border rounded px-3 py-2"/>
            <input name="location" placeholder="Location description / street" class="w-full border rounded px-3 py-2"/>
            <input name="photo" placeholder="Photo URL (optional)" class="w-full border rounded px-3 py-2"/>
            <textarea name="notes" placeholder="Notes (water depth, blocked road...)" class="w-full border rounded px-3 py-2"></textarea>
            <div class="flex gap-2">
              <button type="submit" class="bg-teal-600 text-white py-2 px-3 rounded">Add Report</button>
              <button id="clearReports" type="button" class="bg-gray-200 py-2 px-3 rounded">Clear All</button>
            </div>
          </form>
          <div id="reportsList" class="mt-3 max-h-56 overflow-auto space-y-2 text-sm text-gray-700">
            <div class="text-center text-gray-400 py-6">No reports yet</div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow">
          <h4 class="font-semibold">👥 Emergency Contacts</h4>
          <form id="contactForm" class="mt-3 space-y-2">
            <input name="name" placeholder="Full name" class="w-full border rounded px-3 py-2"/>
            <input name="phone" placeholder="Phone (e.g. +92300...)" class="w-full border rounded px-3 py-2"/>
            <select name="role" class="w-full border rounded px-3 py-2">
              <option value="citizen">Citizen</option>
              <option value="volunteer">Volunteer</option>
              <option value="official">Official</option>
            </select>
            <div class="flex gap-2">
              <button type="submit" class="bg-green-600 text-white py-2 px-3 rounded">Add Contact</button>
              <button id="exportContacts" type="button" class="bg-gray-200 py-2 px-3 rounded">Export</button>
            </div>
          </form>
          <div id="contactsList" class="mt-3 max-h-44 overflow-auto text-sm space-y-2 text-gray-700">
            <div class="text-center text-gray-400 py-6">No contacts yet</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Notifications container (programmatic) -->
  <div id="notificationsRoot"></div>

  <!-- Minimal Service Worker (PWA-lite) -->
  <script>
    if ('serviceWorker' in navigator) {
      try {
        navigator.serviceWorker.register('sw.js').catch(()=>{/* ignore registration failure in local dev */});
      } catch(e){}
    }
  </script>

  <script>
  /* ============================
     Application state & storage
     ============================ */
  const DEFAULTS = {
    weatherApiKey: localStorage.getItem('floodguard_weather_key') || '',
    emailjsPublicKey: localStorage.getItem('floodguard_emailjs_public') || '',
    emailjsServiceId: localStorage.getItem('floodguard_emailjs_service') || '',
    emailjsTemplateId: localStorage.getItem('floodguard_emailjs_template') || '',
    defaultLocation: JSON.parse(localStorage.getItem('floodguard_location') || '[24.8607,67.0011]'),
    smsProvider: localStorage.getItem('floodguard_sms_provider') || 'none',
    smsConfig: localStorage.getItem('floodguard_sms_config') || '',
  };

  const STATE = {
    currentWeather: null,
    alerts: JSON.parse(localStorage.getItem('floodguard_alerts') || '[]'),
    reports: JSON.parse(localStorage.getItem('floodguard_reports') || '[]'),
    contacts: JSON.parse(localStorage.getItem('floodguard_contacts') || '[]'),
    mapMarkers: [],
    map: null,
    userMarker: null,
    shelters: JSON.parse(localStorage.getItem('floodguard_shelters') || '[]')
  };

  /* ============================
     Simple UI helpers
     ============================ */
  function showNotification(message, type='info', duration=4000){
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.innerHTML = `<div class="flex justify-between items-start gap-3">
                     <div>${message}</div>
                     <button aria-label="close">×</button>
                   </div>`;
    n.querySelector('button').onclick = ()=>n.remove();
    document.body.appendChild(n);
    setTimeout(()=>n.remove(), duration);
  }

  function save(key, value){
    localStorage.setItem(`floodguard_${key}`, JSON.stringify(value));
  }

  function load(key, fallback){ 
    const raw = localStorage.getItem(`floodguard_${key}`);
    return raw ? JSON.parse(raw) : fallback;
  }

  /* ============================
     Weather fetching & risk logic
     ============================ */
  async function fetchWeatherData(){
    const apiKey = DEFAULTS.weatherApiKey = (document.getElementById('weatherApiKey').value || DEFAULTS.weatherApiKey);
    if(!apiKey) { showNotification(lang('noApiKey','Please set OpenWeather API key'), 'warning'); return null; }

    const [lat, lon] = DEFAULTS.defaultLocation;
    try{
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`);
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const data = await res.json();
      STATE.currentWeather = data;
      updateWeatherDisplay(data);
      showNotification(lang('weatherUpdated','Weather updated'), 'success', 2500);
      updateRiskAssessment();
      return data;
    } catch(err){
      console.error(err);
      showNotification(lang('weatherFailed','Failed to fetch weather: ') + err.message, 'error', 6000);
      return null;
    }
  }

  function updateWeatherDisplay(weather){
    if(!weather) return;
    document.getElementById('temp').textContent = `${weather.main.temp.toFixed(1)}°C`;
    document.getElementById('humidity').textContent = `${weather.main.humidity}%`;
    document.getElementById('pressure').textContent = `${weather.main.pressure} hPa`;
    document.getElementById('rainfall').textContent = weather.rain?.['1h'] ? `${weather.rain['1h'].toFixed(1)} mm` : '0 mm';
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString('en-PK', { timeZone:'Asia/Karachi', hour12:true });
  }

  function updateRiskAssessment(){
    const w = STATE.currentWeather;
    const rainOverride = 0; // could add UI for manual override
    let score = 0;
    if(w){
      const rainfall = rainOverride || (w.rain?.['1h'] || 0);
      score += Math.min((rainfall / 50) * 40, 40);         // rainfall factor
      score += Math.min((w.main.humidity / 100) * 30, 30); // humidity factor scaled
      score += w.main.pressure < 1000 ? 10 : 0;            // low pressure
      // Additional heuristics could be added (wind, forecasted rainfall)
    }
    score = Math.round(score);
    const level = getRiskLevel(score);
    document.getElementById('riskScore').textContent = score;
    const badge = document.getElementById('riskBadge');
    badge.textContent = level.label;
    badge.className = `px-3 py-1 rounded-full text-xs font-semibold ${level.class}`;
    document.getElementById('riskDescription').textContent = level.description;

    // If severe, create an automatic alert (one every 30 minutes max)
    if(score >= 70 && !recentAutoAlert()) {
      const message = `⚠️ ${level.label} — ${level.description} (Risk ${score})`;
      addAlert({type:'auto', message, time: Date.now()});
      // optionally call a webhook / EmailJS here
    }
  }

  function getRiskLevel(score){
    if(score < 20) return { label: lang('low','Low Risk'), class: 'bg-green-100 text-green-700', description: lang('normalConditions','Normal conditions. Continue monitoring.') };
    if(score < 40) return { label: lang('moderate','Moderate'), class: 'bg-yellow-100 text-yellow-700', description: lang('increasedMonitoring','Increased monitoring recommended.') };
    if(score < 70) return { label: lang('high','High Risk'), class: 'bg-orange-100 text-orange-700', description: lang('prepareEvacuate','Alert condition. Prepare for possible evacuation.') };
    return { label: lang('severe','Severe'), class: 'bg-red-100 text-red-700', description: lang('actNow','Severe flood danger. Immediate action required!') };
  }

  function recentAutoAlert(){
    const alerts = load('alerts', []);
    const lastAuto = alerts.filter(a=>a.type==='auto').sort((a,b)=>b.time-a.time)[0];
    if(!lastAuto) return false;
    return (Date.now() - lastAuto.time) < (30*60*1000); // 30 minutes window
  }

  function addAlert(alert){
    const alerts = load('alerts', []);
    alerts.unshift(alert);
    save('alerts', alerts);
    // update UI (here, just a notification)
    showNotification(alert.message, 'warning', 6000);
  }

  /* ============================
     Map, shelters & reports
     ============================ */
  const defaultShelters = [
    // example shelters (replace or expand)
    { id: 's1', name: 'DMC Shelter - Saddar', lat: 24.8610, lng: 67.0090, type: 'shelter' },
    { id: 's2', name: 'Community Center Gulshan', lat: 24.9125, lng: 67.1366, type: 'shelter' },
    { id: 's3', name: 'School Hall Korangi', lat: 24.8500, lng: 67.0500, type: 'shelter' }
  ];
  if(!STATE.shelters || STATE.shelters.length === 0) {
    STATE.shelters = defaultShelters;
    save('shelters', STATE.shelters);
  }

  function initMap(){
    const [lat, lon] = DEFAULTS.defaultLocation || [24.8607,67.0011];
    const map = L.map('map').setView([lat, lon], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    STATE.map = map;
    // Add shelter markers
    STATE.shelters.forEach(s => {
      const m = L.marker([s.lat, s.lng], { title: s.name, riseOnHover:true }).addTo(map);
      m.bindPopup(`<strong>${s.name}</strong><div class="text-xs">${s.type}</div><div class="mt-2"><button onclick="nearestShelterFrom(${s.lat},${s.lng})" class="px-2 py-1 text-xs rounded bg-blue-600 text-white">Navigate</button></div>`);
      STATE.mapMarkers.push(m);
    });

    // load reports
    loadReportsToMap();

    // click to add marker quick (optional)
    map.on('contextmenu', (e)=> {
      // right-click to add temporary danger marker
      const marker = L.circleMarker(e.latlng, { color: 'red', radius:8 }).addTo(map);
      marker.bindPopup(`<strong>${lang('reportedDanger','Reported danger')}</strong>`).openPopup();
      setTimeout(()=>marker.remove(), 60_000); // temporary
    });
  }

  function loadReportsToMap(){
    // clear previous
    STATE.mapMarkers.forEach(m => m.remove());
    STATE.mapMarkers = [];

    // add shelters first
    STATE.shelters.forEach(s => {
      const m = L.marker([s.lat, s.lng], { title: s.name }).addTo(STATE.map);
      m.bindPopup(`<strong>${s.name}</strong><div class="text-xs">Shelter</div>`);
      STATE.mapMarkers.push(m);
    });

    const reports = load('reports', []);
    reports.forEach(r => {
      const marker = L.marker([r.lat, r.lng], { icon: L.divIcon({ className:'report-pin', html:`<div style="background:#2563eb;border-radius:50%;width:12px;height:12px"></div>` }) }).addTo(STATE.map);
      const imgHtml = r.photo ? `<img src="${r.photo}" style="max-width:180px;margin-top:6px;border-radius:6px" />` : '';
      marker.bindPopup(`<strong>${r.reporter || 'Report'}</strong><div class="text-xs">${r.location || ''}</div><div style="margin-top:6px">${r.notes || ''}</div>${imgHtml}`);
      STATE.mapMarkers.push(marker);
    });
  }

  function addReportToStorage(report){
    const reports = load('reports', []);
    reports.unshift(report);
    save('reports', reports);
    loadReportsToMap();
    renderReportsList();
  }

  /* ============================
     Utility: Haversine (nearest)
     ============================ */
  function haversineDistance(lat1, lon1, lat2, lon2){
    const toRad = x => x * Math.PI / 180;
    const R = 6371; // km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function findNearestShelter(lat, lng){
    let best = null;
    STATE.shelters.forEach(s => {
      const d = haversineDistance(lat, lng, s.lat, s.lng);
      if(!best || d < best.dist) best = { shelter: s, dist: d };
    });
    return best;
  }

  async function nearestShelterBtnHandler(){
    const map = STATE.map;
    if(!map) return;
    try {
      const pos = await getCurrentPosition();
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      const nearest = findNearestShelter(lat, lng);
      if(nearest) {
        map.setView([nearest.shelter.lat, nearest.shelter.lng], 14, { animate:true });
        L.popup().setLatLng([nearest.shelter.lat, nearest.shelter.lng])
          .setContent(`<strong>${nearest.shelter.name}</strong><div class="text-xs">~${nearest.dist.toFixed(2)} km away</div>`)
          .openOn(map);
      } else {
        showNotification(lang('noShelters','No shelters available'), 'warning');
      }
    } catch(err){
      showNotification(lang('noLocation','Could not get your location — using default map center'), 'warning');
      map.setView(DEFAULTS.defaultLocation, 11);
    }
  }

  // helper to navigate when clicking shelter popup button
  window.nearestShelterFrom = function(lat, lng){
    if(!STATE.map) return;
    STATE.map.setView([lat,lng], 16);
  };

  /* ============================
     Contacts & Reports UI
     ============================ */
  function renderReportsList(){
    const container = document.getElementById('reportsList');
    const reports = load('reports', []);
    container.innerHTML = '';
    if(reports.length === 0) {
      container.innerHTML = `<div class="text-center text-gray-400 py-6">${lang('noReports','No reports yet')}</div>`;
      return;
    }
    reports.forEach(r => {
      const el = document.createElement('div');
      el.className = 'p-2 border rounded';
      el.innerHTML = `<div class="flex justify-between"><div class="font-semibold">${escapeHtml(r.reporter||'Anonymous')}</div><div class="text-xs text-gray-500">${new Date(r.time).toLocaleString()}</div></div>
                      <div class="text-sm mt-1">${escapeHtml(r.location||'')}</div>
                      <div class="text-xs mt-1">${escapeHtml(r.notes||'')}</div>
                      ${r.photo?`<img src="${r.photo}" style="max-width:100%;margin-top:6px;border-radius:6px">`:''}`;
      container.appendChild(el);
    });
  }

  function renderContacts(){
    const container = document.getElementById('contactsList');
    const contacts = load('contacts', []);
    container.innerHTML = '';
    if(contacts.length === 0) {
      container.innerHTML = `<div class="text-center text-gray-400 py-6">${lang('noContacts','No contacts yet')}</div>`;
      return;
    }
    contacts.forEach(c => {
      const el = document.createElement('div');
      el.className = 'p-2 border rounded flex justify-between items-center';
      el.innerHTML = `<div><div class="font-semibold">${escapeHtml(c.name)}</div><div class="text-xs text-gray-500">${escapeHtml(c.role)} • ${escapeHtml(c.phone||'')}</div></div>
                      <div class="flex flex-col gap-1">
                        <a class="text-xs text-blue-600" href="tel:${c.phone}">Call</a>
                        <a class="text-xs text-blue-600" href="sms:${c.phone}?body=${encodeURIComponent(lang('helpMsg','Need help — flooding at my location'))}">SMS</a>
                      </div>`;
      container.appendChild(el);
    });
  }

  document.getElementById('reportForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const f = ev.target;
    const report = {
      reporter: f.reporter.value || 'Anonymous',
      location: f.location.value || '',
      photo: f.photo.value || '',
      notes: f.notes.value || '',
      time: Date.now()
    };
    // try to attach current map center as coords, or ask geolocation
    if(STATE.map){
      const center = STATE.map.getCenter();
      report.lat = center.lat;
      report.lng = center.lng;
    } else {
      report.lat = DEFAULTS.defaultLocation[0];
      report.lng = DEFAULTS.defaultLocation[1];
    }
    addReportToStorage(report);
    showNotification(lang('reportAdded','Report added'), 'success');
    f.reset();
    renderReportsList();
  });

  document.getElementById('clearReports').addEventListener('click', ()=>{
    if(!confirm(lang('clearReportsConfirm','Clear all reports?'))) return;
    save('reports', []);
    renderReportsList();
    loadReportsToMap();
  });

  document.getElementById('contactForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const f = ev.target;
    const contact = {
      name: f.name.value,
      phone: f.phone.value,
      role: f.role.value
    };
    const contacts = load('contacts', []);
    contacts.unshift(contact);
    save('contacts', contacts);
    renderContacts();
    f.reset();
    showNotification(lang('contactAdded','Contact added'), 'success');
  });

  document.getElementById('exportContacts').addEventListener('click', ()=>{
    const contacts = load('contacts', []);
    const blob = new Blob([JSON.stringify(contacts, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'contacts.json';
    a.click(); URL.revokeObjectURL(url);
  });

  /* ============================
     Small utilities
     ============================ */
  function escapeHtml(t){ return (t+'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

  function getCurrentPosition(options={enableHighAccuracy:true, timeout:8000}){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error('No geolocation'));
      navigator.geolocation.getCurrentPosition(resolve, reject, options);
    });
  }

  /* ============================
     Language strings (EN/UR)
     ============================ */
  const STRINGS = {
    en: {
      noApiKey: 'Please set OpenWeather API key',
      weatherUpdated: 'Weather updated',
      weatherFailed: 'Failed to fetch weather: ',
      low: 'Low Risk', moderate: 'Moderate', high: 'High Risk', severe: 'Severe',
      normalConditions: 'Normal conditions. Continue monitoring.',
      increasedMonitoring: 'Increased monitoring recommended.',
      prepareEvacuate: 'Alert condition. Prepare for possible evacuation.',
      actNow: 'Severe flood danger. Immediate action required!',
      noShelters: 'No shelters available',
      noLocation: 'Could not get your location — using default map center',
      reportedDanger: 'Reported danger',
      noReports: 'No reports yet',
      reportAdded: 'Report added',
      clearReportsConfirm: 'Clear all reports?',
      noContacts: 'No contacts yet',
      contactAdded: 'Contact added',
      helpMsg: 'Need help — flooding at my location'
    },
    ur: {
      noApiKey: 'براہِ کرم OpenWeather API کلید درج کریں',
      weatherUpdated: 'موسم کی تازہ ترین معلومات حاصل ہو گئیں',
      weatherFailed: 'موسم حاصل کرنے میں ناکامی: ',
      low: 'کم خطرہ', moderate: 'درمیانہ', high: 'زیادہ خطرہ', severe: 'شدید خطرہ',
      normalConditions: 'حالت نارمل ہے۔ نگرانی جاری رکھیں۔',
      increasedMonitoring: 'زیادہ نگرانی کی سفارش کی جاتی ہے۔',
      prepareEvacuate: 'خبردار: ممکنہ انخلاء کی تیاری کریں۔',
      actNow: 'شدید سیلابی خطرہ۔ فوری کارروائی ضروری!',
      noShelters: 'کوئی شیلٹر دستیاب نہیں',
      noLocation: 'مقام حاصل نہیں ہوا — نقشہ کے ڈیفالٹ مرکز کا استعمال',
      reportedDanger: 'خطرے کی اطلاع',
      noReports: 'ابھی کوئی رپورٹ نہیں',
      reportAdded: 'رپورٹ شامل کر دی گئی',
      clearReportsConfirm: 'کیا آپ تمام رپورٹس صاف کرنا چاہتے ہیں؟',
      noContacts: 'ابھی کوئی رابطہ نہیں',
      contactAdded: 'رابطہ شامل کر دیا گیا',
      helpMsg: 'مدد درکار — میرا مقام یہاں سیلاب زدہ ہے'
    }
  };

  function lang(key, fallback){
    const l = document.getElementById('langSelect').value || 'en';
    return (STRINGS[l] && STRINGS[l][key]) || fallback || key;
  }

  /* ============================
     Event wiring & startup
     ============================ */
  document.getElementById('refreshWeather').addEventListener('click', fetchWeatherData);
  document.getElementById('locateMe').addEventListener('click', async ()=>{
    try{
      const pos = await getCurrentPosition();
      STATE.map.setView([pos.coords.latitude, pos.coords.longitude], 14);
      if(STATE.userMarker) STATE.userMarker.remove();
      STATE.userMarker = L.marker([pos.coords.latitude, pos.coords.longitude], {title: 'You'}).addTo(STATE.map);
      STATE.userMarker.bindPopup('You are here').openPopup();
    }catch(err){
      showNotification(lang('noLocation','Could not get your location'), 'warning');
    }
  });

  document.getElementById('nearestShelterBtn').addEventListener('click', nearestShelterBtnHandler);

  document.getElementById('emergencyCall').addEventListener('click', ()=>{
    // tel link will open phone dialer on mobile
    window.location.href = 'tel:1122';
  });

  document.getElementById('shareLocationBtn').addEventListener('click', async ()=>{
    try {
      const pos = await getCurrentPosition();
      const short = `My location: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
      // copy to clipboard and show message
      await navigator.clipboard.writeText(short);
      showNotification(lang('helpMsg','Location copied to clipboard — share it with responders'), 'success');
    } catch(e){
      showNotification(lang('noLocation','Could not get your location'), 'warning');
    }
  });

  document.getElementById('addReportBtn').addEventListener('click', ()=>{
    document.getElementById('reportForm').reporter.focus();
    showNotification(lang('reportAdded','Fill the report form and submit'), 'info', 2500);
  });

  // Save configuration
  document.getElementById('saveConfig').addEventListener('click', ()=>{
    DEFAULTS.weatherApiKey = document.getElementById('weatherApiKey').value.trim();
    DEFAULTS.emailjsPublicKey = document.getElementById('emailjsPublicKey').value.trim();
    DEFAULTS.emailjsServiceId = document.getElementById('emailjsServiceId').value.trim();
    DEFAULTS.emailjsTemplateId = document.getElementById('emailjsTemplateId').value.trim();
    const loc = (document.getElementById('defaultLocation').value || '').trim();
    if(loc){ 
      DEFAULTS.defaultLocation = loc.split(',').map(n=>Number(n.trim()));
      localStorage.setItem('floodguard_location', JSON.stringify(DEFAULTS.defaultLocation));
    }
    DEFAULTS.smsProvider = document.getElementById('smsProvider').value;
    DEFAULTS.smsConfig = document.getElementById('smsConfig').value.trim();

    if(DEFAULTS.weatherApiKey) localStorage.setItem('floodguard_weather_key', DEFAULTS.weatherApiKey);
    if(DEFAULTS.emailjsPublicKey) localStorage.setItem('floodguard_emailjs_public', DEFAULTS.emailjsPublicKey);
    if(DEFAULTS.emailjsServiceId) localStorage.setItem('floodguard_emailjs_service', DEFAULTS.emailjsServiceId);
    if(DEFAULTS.emailjsTemplateId) localStorage.setItem('floodguard_emailjs_template', DEFAULTS.emailjsTemplateId);
    localStorage.setItem('floodguard_sms_provider', DEFAULTS.smsProvider);
    localStorage.setItem('floodguard_sms_config', DEFAULTS.smsConfig);

    showNotification(lang('contactAdded','Configuration saved'), 'success', 2000);
  });

  // Test/Send Email (EmailJS) — optional and requires keys
  document.getElementById('testEmailBtn').addEventListener('click', async ()=>{
    const pub = DEFAULTS.emailjsPublicKey || document.getElementById('emailjsPublicKey').value.trim();
    const service = DEFAULTS.emailjsServiceId || document.getElementById('emailjsServiceId').value.trim();
    const template = DEFAULTS.emailjsTemplateId || document.getElementById('emailjsTemplateId').value.trim();
    if(!pub || !service || !template) {
      showNotification('EmailJS keys missing', 'warning');
      return;
    }
    try {
      emailjs.init(pub);
      const params = { message: 'Test alert from FloodGuard', time: new Date().toLocaleString() };
      await emailjs.send(service, template, params);
      showNotification('Test email sent', 'success');
    } catch(err){
      console.error(err);
      showNotification('Email send failed: ' + err.message, 'error');
    }
  });

  // Manual broadcast (store alert + optionally call webhook)
  document.getElementById('manualAlertBtn').addEventListener('click', async ()=>{
    const message = prompt('Enter alert message to broadcast:', 'Flood alert: move to higher ground');
    if(!message) return;
    addAlert({ type:'manual', message, time: Date.now() });
    // optional: call webhook if configured
    if(DEFAULTS.smsProvider === 'webhook' && DEFAULTS.smsConfig){
      try {
        await fetch(DEFAULTS.smsConfig, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message }) });
        showNotification('Webhook called', 'success');
      } catch(e){
        showNotification('Webhook failed: ' + e.message, 'error');
      }
    }
  });

  // Render lists on load
  function bootUI(){
    // prefill config inputs from localStorage
    if(localStorage.getItem('floodguard_weather_key')) document.getElementById('weatherApiKey').value = localStorage.getItem('floodguard_weather_key');
    if(localStorage.getItem('floodguard_emailjs_public')) document.getElementById('emailjsPublicKey').value = localStorage.getItem('floodguard_emailjs_public');
    if(localStorage.getItem('floodguard_emailjs_service')) document.getElementById('emailjsServiceId').value = localStorage.getItem('floodguard_emailjs_service');
    if(localStorage.getItem('floodguard_emailjs_template')) document.getElementById('emailjsTemplateId').value = localStorage.getItem('floodguard_emailjs_template');
    if(localStorage.getItem('floodguard_location')) document.getElementById('defaultLocation').value = JSON.parse(localStorage.getItem('floodguard_location')).join(',');
    if(localStorage.getItem('floodguard_sms_provider')) document.getElementById('smsProvider').value = localStorage.getItem('floodguard_sms_provider');
    if(localStorage.getItem('floodguard_sms_config')) document.getElementById('smsConfig').value = localStorage.getItem('floodguard_sms_config');

    renderReportsList();
    renderContacts();
  }

  // Attach reports list on load
  document.addEventListener('DOMContentLoaded', async ()=>{
    initMap();
    bootUI();
    await fetchWeatherData();
  });

  // language switching: update small labels when changed
  document.getElementById('langSelect').addEventListener('change', ()=>{
    document.getElementById('guideTitle').textContent = (document.getElementById('langSelect').value === 'ur') ? '🚀 فوری ہدایت' : '🚀 Quick Setup';
    document.getElementById('weatherTitle').textContent = (document.getElementById('langSelect').value === 'ur') ? '🌤️ موجودہ موسم' : '🌤️ Current Weather';
    // (for brevity, we update many strings on demand via lang() in notifications and logic)
  });

  </script>

  <!-- Minimal offline service worker file (create /sw.js next to this file) -->
  <script>
    // Create a small service worker file content dynamically for local dev convenience.
    // If your server does not allow creating files, ignore this - you can create sw.js manually.
    (async ()=> {
      if ('serviceWorker' in navigator) {
        try {
          const swUrl = 'sw.js';
          // fetch to see if exists
          const res = await fetch(swUrl, {method:'HEAD'});
          if(!res.ok){
            // create a blob and register from blob (not persistent across reloads but helpful locally)
            const swCode = `
              const CACHE = 'floodguard-v1';
              const ASSETS = ['/', '/index.html'];
              self.addEventListener('install', e => {
                self.skipWaiting();
                e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).catch(()=>{}));
              });
              self.addEventListener('fetch', e => {
                e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)).catch(()=>fetch(e.request)));
              });
            `;
            const blob = new Blob([swCode], {type:'application/javascript'});
            const blobUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(blobUrl).catch(()=>{/* ignore */});
          }
        } catch(e){}
      }
    })();
  </script>
</body>
</html>
